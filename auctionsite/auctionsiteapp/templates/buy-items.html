{% extends 'item_list.html' %}

{% block form %}
<div class="container">
  <div class="text-center">
    <h1>Search for an Item</h1>
    <form id='searchForm'>
      {% csrf_token %}
      <input name='query' type='text' placeholder='Search'/>
      <button id="searchBtn" type="button">
        Search
      </button>
    </form>
    {% for item in items %}
      <div class="col-md-3 text-center" id='item-list'>
        <h2>{{ item.title }}</h2>
        <img src="{{ item.picture.url }}" alt="{{ item.title }}" height="200" width="200">
        {% for bid in bids %}
          {% if bid.item_id == item.id %}
            {% if forloop.last %}
              <p>Current bid: Â£<span id="currentbid">{{bid.price}}</span></p>
            {% endif %}
          {% endif %}
        {% endfor %}
        <p>Auction end: {{item.endDate}}</p>
        <form>
          {% csrf_token %}
          <div>
            <label>Price</label>
            <input id="price{{ item.id }}" type="text" name="price" placeholder="0">
          </div>
        </form>
        <button class="bidButton" id="bidButton{{ item.id }}">Submit Bid</button>
        <p id='error{{ item.id }}'></p>
      </div>
    {% endfor %}
  </div>
</div>
{% endblock %}
{% block scripts %}
<script>
  $(() => {
    $(document).on("keydown", "form", (event) => {
        return event.key != "Enter";
      });
    $.ajax({
      url: "{% url 'auctionsiteapp:itemsjson' %}",
      success: (data) => {
        $("#itemList").empty();
        for (let i=0; i<data.items.length; i++) {
          const item = data.items[i];
          $("#itemList").append(createListItem(item, false));
        }
      }
    });
    $("#searchBtn").click(() => {
      $.ajax({
        url: "{% url 'auctionsiteapp:itemsjson' %}",
        data: $("#searchForm").serializeArray(),
        success: (data) => {
          $("#itemList").empty();
          for (let i=0; i<data.items.length; i++) {
            const item = data.items[i];
            $("#itemList").append(createListItem(item, false));
          }
        }
      });
    });
    $('main').on('click', '.bidButton', (obj) => {
      const btnClicked = obj.currentTarget.id;
      const targetPrice = btnClicked.replace('bidButton', 'price');
      const pk = btnClicked.replace('bidButton', '');
      const userId = {{ user.id }};
      $.ajax({
        type: 'PUT',
        url: "{% url 'auctionsiteapp:editBid' %}",
        headers: { "X-CSRFToken": $("[name=csrfmiddlewaretoken]").val() },
        data: {
          price: $(`#${targetPrice}`).val(),
          item: pk,
          userid: userId
        },
        success: (data) => {
          // bid = parseFloat(data.price).toFixed(2);
          // $(`#currentbid${pk}`).text(bid);
          // if (data.error) {
          //   $(`#error${pk}`).text(data.error);
          // } else {
          //   $(`#error${pk}`).empty('&nbsp');
          // }
        }
      })
    })
  })
</script>
{% endblock %}


<!-- success: (data) => {
  $('#showUsername').text("Username: " + data.username);
}, -->
